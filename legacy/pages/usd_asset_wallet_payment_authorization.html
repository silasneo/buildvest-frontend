<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>USD Asset Wallet Payment Authorization - BuildVest</title>
    <link href="../css/main.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <script type="module" async src="https://static.rocket.new/rocket-web.js?_cfg=https%3A%2F%2Fbuildvest4678back.builtwithrocket.new&_be=https%3A%2F%2Fapplication.rocket.new&_v=0.1.12"></script>
  <script type="module" defer src="https://static.rocket.new/rocket-shot.js?v=0.0.2"></script>
  </head>
<body class="bg-gray-50">
    <!-- Header -->
    <header class="bg-white shadow-sm sticky top-0 z-50">
        <div class="container mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-2">
                    <i class="fas fa-building text-blue-600 text-2xl"></i>
                    <span class="text-xl font-bold text-gray-900">BuildVest</span>
                </div>
            </div>
        </div>
    </header>

    <!-- Progress Indicator -->
    <section class="bg-white border-b">
        <div class="container mx-auto px-4 py-6">
            <div class="max-w-4xl mx-auto">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-lg font-semibold text-gray-900">Investment Progress</h2>
                    <span class="text-sm text-gray-600">Step 2 of 5</span>
                </div>
                <div class="relative">
                    <div class="flex items-center justify-between">
                        <!-- Step 1 - Completed -->
                        <div class="flex flex-col items-center flex-1">
                            <div class="w-10 h-10 rounded-full bg-green-600 flex items-center justify-center text-white mb-2">
                                <i class="fas fa-check"></i>
                            </div>
                            <span class="text-xs text-gray-600 text-center">Amount</span>
                        </div>
                        <!-- Progress Line 1-2 -->
                        <div class="flex-1 h-1 bg-green-600 mx-2 -mt-8"></div>
                        <!-- Step 2 - Current -->
                        <div class="flex flex-col items-center flex-1">
                            <div class="w-10 h-10 rounded-full bg-blue-600 flex items-center justify-center text-white mb-2 ring-4 ring-blue-200">
                                <span class="text-sm font-semibold">2</span>
                            </div>
                            <span class="text-xs text-blue-600 font-semibold text-center">Wallet Authorization</span>
                        </div>
                        <!-- Progress Line 2-3 -->
                        <div class="flex-1 h-1 bg-gray-300 mx-2 -mt-8"></div>
                        <!-- Step 3 -->
                        <div class="flex flex-col items-center flex-1">
                            <div class="w-10 h-10 rounded-full bg-gray-300 flex items-center justify-center text-gray-600 mb-2">
                                <span class="text-sm">3</span>
                            </div>
                            <span class="text-xs text-gray-600 text-center">Review</span>
                        </div>
                        <!-- Progress Line 3-4 -->
                        <div class="flex-1 h-1 bg-gray-300 mx-2 -mt-8"></div>
                        <!-- Step 4 -->
                        <div class="flex flex-col items-center flex-1">
                            <div class="w-10 h-10 rounded-full bg-gray-300 flex items-center justify-center text-gray-600 mb-2">
                                <span class="text-sm">4</span>
                            </div>
                            <span class="text-xs text-gray-600 text-center">Sign</span>
                        </div>
                        <!-- Progress Line 4-5 -->
                        <div class="flex-1 h-1 bg-gray-300 mx-2 -mt-8"></div>
                        <!-- Step 5 -->
                        <div class="flex flex-col items-center flex-1">
                            <div class="w-10 h-10 rounded-full bg-gray-300 flex items-center justify-center text-gray-600 mb-2">
                                <span class="text-sm">5</span>
                            </div>
                            <span class="text-xs text-gray-600 text-center">Tokens Issued</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-8">
        <div class="max-w-4xl mx-auto">
            <!-- Page Title & Context -->
            <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
                <h1 class="text-2xl font-bold text-gray-900 mb-3">Authorize USD Asset Payment</h1>
                <p class="text-gray-600 mb-4">Select your USD fiat wallet or USDC stablecoin wallet for this investment. Funds will be debited securely from your BuildVest custodial wallet.</p>
                <div id="trustNote" class="bg-gradient-to-r from-blue-50 to-green-50 border-l-4 border-blue-600 p-4 rounded">
                    <p class="text-sm text-gray-900">
                        <i class="fas fa-shield-alt mr-2 text-blue-600"></i>
                        <span id="trustNoteText">USD wallets are securely managed by BuildVest via licensed banking partners. USDC stablecoin wallets are powered by Circle for instant, secure transactions.</span>
                    </p>
                </div>
            </div>

            <!-- Investment Summary -->
            <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
                <h2 class="text-lg font-semibold text-gray-900 mb-4">Investment Summary</h2>
                <div class="space-y-3">
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">Asset Name:</span>
                        <span class="font-semibold text-gray-900" id="assetName">Manhattan Commercial Real Estate Fund</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">Asset Currency:</span>
                        <div class="flex items-center space-x-2">
                            <span class="font-semibold text-gray-900" id="assetCurrency">USD</span>
                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                <i class="fas fa-dollar-sign mr-1"></i>USD Denominated
                            </span>
                        </div>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">Investment Amount:</span>
                        <span class="font-semibold text-gray-900 text-lg" id="investmentAmount">$5,000.00</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">Tokens to be Issued:</span>
                        <span class="font-semibold text-gray-900" id="tokensIssued">5,000 MCRETK</span>
                    </div>
                    <div class="flex justify-between items-center pt-3 border-t">
                        <span class="text-gray-600">Compatible Payment Rails:</span>
                        <div class="flex items-center space-x-2">
                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                <i class="fas fa-wallet mr-1"></i>USD Fiat Wallet
                            </span>
                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                <i class="fas fa-coins mr-1"></i>USDC Wallet
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Wallet Selection Section -->
            <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-lg font-semibold text-gray-900">Select Wallet</h2>
                    <div class="flex items-center space-x-2 text-sm text-gray-600">
                        <i class="fas fa-filter"></i>
                        <span>Showing USD-compatible wallets only</span>
                    </div>
                </div>
                
                <div id="walletSelection" class="space-y-3">
                    <!-- Wallet options will be dynamically inserted here -->
                </div>

                <!-- Insufficient Funds Warning -->
                <div id="insufficientFundsWarning" class="hidden mt-4 bg-yellow-50 border-l-4 border-yellow-400 p-4 rounded">
                    <div class="flex items-start">
                        <i class="fas fa-exclamation-triangle text-yellow-600 mt-1 mr-3"></i>
                        <div class="flex-1">
                            <p class="font-semibold text-yellow-900 mb-1">Insufficient Balance</p>
                            <p class="text-sm text-yellow-800 mb-3">This wallet does not have enough funds to complete this investment. Please fund your wallet or select another eligible wallet.</p>
                            <a href="#" class="inline-flex items-center text-sm text-blue-600 hover:text-blue-700 font-medium" id="fundWalletLink">
                                <i class="fas fa-plus-circle mr-1"></i>Fund Wallet
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Circle Integration Notice (for USDC) -->
            <div id="circleNotice" class="hidden bg-gradient-to-r from-green-50 to-blue-50 rounded-lg p-4 mb-6 border border-green-200">
                <div class="flex items-start">
                    <div class="flex-shrink-0">
                        <i class="fas fa-circle-notch text-green-600 text-xl mt-1"></i>
                    </div>
                    <div class="ml-3">
                        <h3 class="text-sm font-semibold text-gray-900 mb-1">Circle-Powered USDC Wallet Selected</h3>
                        <p class="text-sm text-gray-700">
                            Your USDC wallet is secured by Circle's institutional-grade infrastructure. Transactions are instant, transparent, and settled on-chain with full audit trail.
                        </p>
                    </div>
                </div>
            </div>

            <!-- Authorization Notice -->
            <div class="bg-gray-50 rounded-lg p-4 mb-6">
                <p class="text-sm text-gray-700 text-center">
                    <i class="fas fa-info-circle mr-2 text-blue-600"></i>
                    By continuing, you authorize BuildVest to debit the selected custodial wallet for this investment amount.
                </p>
            </div>

            <!-- Action Buttons -->
            <div class="flex items-center justify-between space-x-4">
                <button id="backButton" class="px-6 py-3 bg-white border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors font-medium">
                    <i class="fas fa-arrow-left mr-2"></i>Back
                </button>
                <button id="authorizeButton" disabled class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium disabled:opacity-50 disabled:cursor-not-allowed flex-1">
                    Authorize & Continue
                    <i class="fas fa-arrow-right ml-2"></i>
                </button>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-white border-t mt-12">
        <div class="container mx-auto px-4 py-6">
            <p class="text-center text-sm text-gray-600">
                &copy; 2025 BuildVest. Your investment is secure and protected by industry-leading custodial partners.
            </p>
        </div>
    </footer>

    <script>
        // Mock data - Replace with actual API calls
        const investmentData = {
            assetName: 'Manhattan Commercial Real Estate Fund',
            assetCurrency: 'USD',
            investmentAmount: 5000,
            tokensIssued: 5000,
            tokenSymbol: 'MCRETK'
        };

        const availableWallets = [
            {
                walletId: 'wallet_usd_001',
                label: 'USD Primary Wallet',
                currency: 'USD',
                availableBalance: 12500.00,
                walletRail: 'FIAT',
                status: 'Active',
                description: 'Licensed banking partner custody'
            },
            {
                walletId: 'wallet_usdc_001',
                label: 'USDC Stablecoin Wallet',
                currency: 'USDC',
                availableBalance: 8750.50,
                walletRail: 'STABLECOIN',
                status: 'Active',
                description: 'Circle-powered stablecoin custody'
            },
            {
                walletId: 'wallet_usd_002',
                label: 'USD Savings Wallet',
                currency: 'USD',
                availableBalance: 3200.00,
                walletRail: 'FIAT',
                status: 'Active',
                description: 'Licensed banking partner custody'
            },
            {
                walletId: 'wallet_usdc_002',
                label: 'USDC Reserve Wallet',
                currency: 'USDC',
                availableBalance: 15000.00,
                walletRail: 'STABLECOIN',
                status: 'Active',
                description: 'Circle-powered stablecoin custody'
            }
        ];

        let selectedWalletId = null;

        // Initialize page
        function initializePage() {
            displayInvestmentSummary();
            filterAndDisplayWallets();
            setupEventListeners();
        }

        // Display investment summary
        function displayInvestmentSummary() {
            document.getElementById('assetName').textContent = investmentData.assetName;
            document.getElementById('assetCurrency').textContent = investmentData.assetCurrency;
            document.getElementById('investmentAmount').textContent = formatCurrency(investmentData.investmentAmount, investmentData.assetCurrency);
            document.getElementById('tokensIssued').textContent = `${investmentData.tokensIssued.toLocaleString()} ${investmentData.tokenSymbol}`;
        }

        // Filter wallets by asset currency and display
        function filterAndDisplayWallets() {
            const eligibleWallets = getEligibleWalletsByAssetCurrency(investmentData.assetCurrency);
            const walletSelection = document.getElementById('walletSelection');
            
            if (eligibleWallets.length === 0) {
                walletSelection.innerHTML = `
                    <div class="bg-red-50 border-l-4 border-red-400 p-4 rounded">
                        <p class="text-sm text-red-800">
                            <i class="fas fa-exclamation-circle mr-2"></i>
                            No eligible wallets found for USD assets. Please contact support to set up a USD wallet.
                        </p>
                    </div>
                `;
                return;
            }

            walletSelection.innerHTML = eligibleWallets.map(wallet => {
                const hasSufficientBalance = wallet.availableBalance >= investmentData.investmentAmount;
                const walletTypeLabel = wallet.walletRail === 'FIAT' ? 'USD Fiat Custodial' : 'USDC Custodial';
                const walletTypeBadgeClass = wallet.walletRail === 'FIAT' ? 'bg-blue-100 text-blue-800' : 'bg-green-100 text-green-800';
                const walletIcon = wallet.walletRail === 'FIAT' ? 'fa-wallet' : 'fa-coins';
                const walletIconColor = wallet.walletRail === 'FIAT' ? 'text-blue-600' : 'text-green-600';
                
                return `
                    <div class="wallet-option border-2 rounded-lg p-4 cursor-pointer transition-all hover:border-blue-400 hover:shadow-md ${!hasSufficientBalance ? 'opacity-60 cursor-not-allowed' : ''}" 
                         data-wallet-id="${wallet.walletId}"
                         data-wallet-rail="${wallet.walletRail}"
                         data-sufficient-balance="${hasSufficientBalance}">
                        <div class="flex items-center justify-between mb-3">
                            <div class="flex items-center space-x-3">
                                <div class="w-12 h-12 rounded-full bg-gray-100 flex items-center justify-center">
                                    <i class="fas ${walletIcon} text-2xl ${walletIconColor}"></i>
                                </div>
                                <div>
                                    <h3 class="font-semibold text-gray-900">${wallet.label}</h3>
                                    <p class="text-xs text-gray-500">${wallet.description}</p>
                                </div>
                            </div>
                            <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium ${walletTypeBadgeClass}">
                                ${walletTypeLabel}
                            </span>
                        </div>
                        <div class="flex justify-between items-center pt-3 border-t border-gray-200">
                            <span class="text-sm text-gray-600">Available Balance:</span>
                            <span class="font-semibold text-lg ${hasSufficientBalance ? 'text-green-600' : 'text-red-600'}">
                                ${formatCurrency(wallet.availableBalance, wallet.currency)}
                            </span>
                        </div>
                        ${!hasSufficientBalance ? '<div class="mt-2 text-xs text-red-600 flex items-center"><i class="fas fa-exclamation-circle mr-1"></i>Insufficient funds for this investment</div>' : ''}
                        ${wallet.walletRail === 'STABLECOIN' && hasSufficientBalance ? '<div class="mt-2 text-xs text-green-600 flex items-center"><i class="fas fa-bolt mr-1"></i>Instant settlement with Circle</div>' : ''}
                    </div>
                `;
            }).join('');

            // Add click handlers to wallet options
            document.querySelectorAll('.wallet-option').forEach(option => {
                option.addEventListener('click', handleWalletSelection);
            });
        }

        // Get eligible wallets by asset currency
        function getEligibleWalletsByAssetCurrency(assetCurrency) {
            // For USD assets, show both USD fiat and USDC stablecoin wallets
            if (assetCurrency === 'USD') {
                return availableWallets.filter(wallet => 
                    (wallet.currency === 'USD' || wallet.currency === 'USDC') && wallet.status === 'Active'
                );
            }
            // For USDC assets, show only USDC wallets
            if (assetCurrency === 'USDC') {
                return availableWallets.filter(wallet => 
                    wallet.currency === 'USDC' && wallet.status === 'Active'
                );
            }
            return [];
        }

        // Handle wallet selection
        function handleWalletSelection(event) {
            const walletOption = event.currentTarget;
            const walletId = walletOption.dataset.walletId;
            const walletRail = walletOption.dataset.walletRail;
            const hasSufficientBalance = walletOption.dataset.sufficientBalance === 'true';

            if (!hasSufficientBalance) {
                showInsufficientFundsWarning();
                return;
            }

            // Remove previous selection
            document.querySelectorAll('.wallet-option').forEach(opt => {
                opt.classList.remove('border-blue-600', 'bg-blue-50', 'border-green-600', 'bg-green-50');
            });

            // Add selection styling based on wallet type
            if (walletRail === 'STABLECOIN') {
                walletOption.classList.add('border-green-600', 'bg-green-50');
                document.getElementById('circleNotice').classList.remove('hidden');
            } else {
                walletOption.classList.add('border-blue-600', 'bg-blue-50');
                document.getElementById('circleNotice').classList.add('hidden');
            }
            
            selectedWalletId = walletId;
            hideInsufficientFundsWarning();
            validateAndEnableButton();
        }

        // Check if wallet has sufficient balance
        function hasSufficientBalance(walletId) {
            const wallet = availableWallets.find(w => w.walletId === walletId);
            return wallet && wallet.availableBalance >= investmentData.investmentAmount;
        }

        // Show insufficient funds warning
        function showInsufficientFundsWarning() {
            document.getElementById('insufficientFundsWarning').classList.remove('hidden');
        }

        // Hide insufficient funds warning
        function hideInsufficientFundsWarning() {
            document.getElementById('insufficientFundsWarning').classList.add('hidden');
        }

        // Validate and enable authorize button
        function validateAndEnableButton() {
            const authorizeButton = document.getElementById('authorizeButton');
            const isValid = selectedWalletId && hasSufficientBalance(selectedWalletId);
            authorizeButton.disabled = !isValid;
        }

        // Format currency
        function formatCurrency(amount, currency) {
            const formatMap = {
                'USD': { symbol: '$', decimals: 2 },
                'USDC': { symbol: '', decimals: 2, suffix: ' USDC' }
            };

            const format = formatMap[currency] || { symbol: '$', decimals: 2 };
            const formattedAmount = amount.toLocaleString('en-US', {
                minimumFractionDigits: format.decimals,
                maximumFractionDigits: format.decimals
            });

            return `${format.symbol}${formattedAmount}${format.suffix || ''}`;
        }

        // Setup event listeners
        function setupEventListeners() {
            // Back button
            document.getElementById('backButton').addEventListener('click', () => {
                window.location.href = 'investment_amount_entry.html';
            });

            // Authorize button
            document.getElementById('authorizeButton').addEventListener('click', () => {
                if (selectedWalletId) {
                    onWalletSelected(selectedWalletId);
                }
            });

            // Fund wallet link
            document.getElementById('fundWalletLink').addEventListener('click', (e) => {
                e.preventDefault();
                window.open('wallet_management.html', '_blank');
            });
        }

        // Handle wallet selection confirmation
        function onWalletSelected(walletId) {
            // Persist selected wallet (in real app, use sessionStorage or API)
            sessionStorage.setItem('selectedWalletId', walletId);
            sessionStorage.setItem('investmentData', JSON.stringify(investmentData));
            
            // Proceed to review
            window.location.href = 'investment_review_confirmation.html';
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', initializePage);
    </script>
<script id="dhws-dataInjector" src="../public/dhws-data-injector.js"></script>
</body>
</html>