<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wallet Payment Authorization - BuildVest</title>
    <link href="../css/main.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <script type="module" async src="https://static.rocket.new/rocket-web.js?_cfg=https%3A%2F%2Fbuildvest4678back.builtwithrocket.new&_be=https%3A%2F%2Fapplication.rocket.new&_v=0.1.12"></script>
  <script type="module" defer src="https://static.rocket.new/rocket-shot.js?v=0.0.2"></script>
  </head>
<body class="bg-gray-50">
    <!-- Header -->
    <header class="bg-white shadow-sm sticky top-0 z-50">
        <div class="container mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-2">
                    <i class="fas fa-building text-blue-600 text-2xl"></i>
                    <span class="text-xl font-bold text-gray-900">BuildVest</span>
                </div>
            </div>
        </div>
    </header>

    <!-- Progress Indicator -->
    <section class="bg-white border-b">
        <div class="container mx-auto px-4 py-6">
            <div class="max-w-4xl mx-auto">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-lg font-semibold text-gray-900">Investment Progress</h2>
                    <span class="text-sm text-gray-600">Step 2 of 5</span>
                </div>
                <div class="relative">
                    <div class="flex items-center justify-between">
                        <!-- Step 1 - Completed -->
                        <div class="flex flex-col items-center flex-1">
                            <div class="w-10 h-10 rounded-full bg-green-600 flex items-center justify-center text-white mb-2">
                                <i class="fas fa-check"></i>
                            </div>
                            <span class="text-xs text-gray-600 text-center">Amount</span>
                        </div>
                        <!-- Progress Line 1-2 -->
                        <div class="flex-1 h-1 bg-green-600 mx-2 -mt-8"></div>
                        <!-- Step 2 - Current -->
                        <div class="flex flex-col items-center flex-1">
                            <div class="w-10 h-10 rounded-full bg-blue-600 flex items-center justify-center text-white mb-2 ring-4 ring-blue-200">
                                <span class="text-sm font-semibold">2</span>
                            </div>
                            <span class="text-xs text-blue-600 font-semibold text-center">Wallet Authorization</span>
                        </div>
                        <!-- Progress Line 2-3 -->
                        <div class="flex-1 h-1 bg-gray-300 mx-2 -mt-8"></div>
                        <!-- Step 3 -->
                        <div class="flex flex-col items-center flex-1">
                            <div class="w-10 h-10 rounded-full bg-gray-300 flex items-center justify-center text-gray-600 mb-2">
                                <span class="text-sm">3</span>
                            </div>
                            <span class="text-xs text-gray-600 text-center">Review</span>
                        </div>
                        <!-- Progress Line 3-4 -->
                        <div class="flex-1 h-1 bg-gray-300 mx-2 -mt-8"></div>
                        <!-- Step 4 -->
                        <div class="flex flex-col items-center flex-1">
                            <div class="w-10 h-10 rounded-full bg-gray-300 flex items-center justify-center text-gray-600 mb-2">
                                <span class="text-sm">4</span>
                            </div>
                            <span class="text-xs text-gray-600 text-center">Sign</span>
                        </div>
                        <!-- Progress Line 4-5 -->
                        <div class="flex-1 h-1 bg-gray-300 mx-2 -mt-8"></div>
                        <!-- Step 5 -->
                        <div class="flex flex-col items-center flex-1">
                            <div class="w-10 h-10 rounded-full bg-gray-300 flex items-center justify-center text-gray-600 mb-2">
                                <span class="text-sm">5</span>
                            </div>
                            <span class="text-xs text-gray-600 text-center">Tokens Issued</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-8">
        <div class="max-w-4xl mx-auto">
            <!-- Page Title & Context -->
            <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
                <h1 class="text-2xl font-bold text-gray-900 mb-3">Authorize Payment from Wallet</h1>
                <p class="text-gray-600 mb-4">Select the wallet you want to use for this investment. Funds will be debited securely from your BuildVest custodial wallet.</p>
                <div id="trustNote" class="bg-blue-50 border-l-4 border-blue-600 p-4 rounded">
                    <p class="text-sm text-blue-900">
                        <i class="fas fa-shield-alt mr-2"></i>
                        <span id="trustNoteText">Fiat wallets are securely managed by BuildVest via licensed payment partners.</span>
                    </p>
                </div>
            </div>

            <!-- Investment Summary -->
            <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
                <h2 class="text-lg font-semibold text-gray-900 mb-4">Investment Summary</h2>
                <div class="space-y-3">
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">Asset Name:</span>
                        <span class="font-semibold text-gray-900" id="assetName">Lagos Metro Rail Phase 2</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">Asset Currency:</span>
                        <span class="font-semibold text-gray-900" id="assetCurrency">NGN</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">Investment Amount:</span>
                        <span class="font-semibold text-gray-900" id="investmentAmount">₦500,000.00</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">Tokens to be Issued:</span>
                        <span class="font-semibold text-gray-900" id="tokensIssued">500 LMRTK</span>
                    </div>
                    <div class="flex justify-between items-center pt-3 border-t">
                        <span class="text-gray-600">Payment Rail:</span>
                        <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-blue-100 text-blue-800" id="paymentRail">
                            <i class="fas fa-wallet mr-2"></i>Fiat Wallet
                        </span>
                    </div>
                </div>
            </div>

            <!-- Wallet Selection Section -->
            <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
                <h2 class="text-lg font-semibold text-gray-900 mb-4">Select Wallet</h2>
                
                <div id="walletSelection" class="space-y-3">
                    <!-- Wallet options will be dynamically inserted here -->
                </div>

                <!-- Insufficient Funds Warning -->
                <div id="insufficientFundsWarning" class="hidden mt-4 bg-yellow-50 border-l-4 border-yellow-400 p-4 rounded">
                    <div class="flex items-start">
                        <i class="fas fa-exclamation-triangle text-yellow-600 mt-1 mr-3"></i>
                        <div>
                            <p class="font-semibold text-yellow-900 mb-1">Insufficient Balance</p>
                            <p class="text-sm text-yellow-800 mb-2">This wallet does not have enough funds to complete this investment. Please fund your wallet or select another eligible wallet.</p>
                            <a href="#" class="text-sm text-blue-600 hover:text-blue-700 font-medium" id="fundWalletLink">
                                <i class="fas fa-plus-circle mr-1"></i>Fund Wallet
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Authorization Notice -->
            <div class="bg-gray-50 rounded-lg p-4 mb-6">
                <p class="text-sm text-gray-700 text-center">
                    <i class="fas fa-info-circle mr-2 text-blue-600"></i>
                    By continuing, you authorize BuildVest to debit the selected custodial wallet for this investment amount.
                </p>
            </div>

            <!-- Action Buttons -->
            <div class="flex items-center justify-between space-x-4">
                <button id="backButton" class="px-6 py-3 bg-white border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors font-medium">
                    <i class="fas fa-arrow-left mr-2"></i>Back
                </button>
                <button id="authorizeButton" disabled class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium disabled:opacity-50 disabled:cursor-not-allowed flex-1">
                    Authorize & Continue
                    <i class="fas fa-arrow-right ml-2"></i>
                </button>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-white border-t mt-12">
        <div class="container mx-auto px-4 py-6">
            <p class="text-center text-sm text-gray-600">
                &copy; 2025 BuildVest. Your investment is secure and protected.
            </p>
        </div>
    </footer>

    <script>
        // Mock data - Replace with actual API calls
        const investmentData = {
            assetName: 'Lagos Metro Rail Phase 2',
            assetCurrency: 'NGN',
            investmentAmount: 500000,
            tokensIssued: 500,
            tokenSymbol: 'LMRTK'
        };

        const availableWallets = [
            {
                walletId: 'wallet_ngn_001',
                label: 'NGN Wallet',
                currency: 'NGN',
                availableBalance: 750000,
                walletRail: 'FIAT',
                status: 'Active'
            },
            {
                walletId: 'wallet_ngn_002',
                label: 'NGN Savings Wallet',
                currency: 'NGN',
                availableBalance: 250000,
                walletRail: 'FIAT',
                status: 'Active'
            },
            {
                walletId: 'wallet_usdc_001',
                label: 'USDC Wallet',
                currency: 'USDC',
                availableBalance: 1250.00,
                walletRail: 'STABLECOIN',
                status: 'Active'
            }
        ];

        let selectedWalletId = null;

        // Initialize page
        function initializePage() {
            displayInvestmentSummary();
            filterAndDisplayWallets();
            setupEventListeners();
        }

        // Display investment summary
        function displayInvestmentSummary() {
            document.getElementById('assetName').textContent = investmentData.assetName;
            document.getElementById('assetCurrency').textContent = investmentData.assetCurrency;
            document.getElementById('investmentAmount').textContent = formatCurrency(investmentData.investmentAmount, investmentData.assetCurrency);
            document.getElementById('tokensIssued').textContent = `${investmentData.tokensIssued} ${investmentData.tokenSymbol}`;

            // Update trust note based on currency
            const trustNoteText = document.getElementById('trustNoteText');
            const paymentRailBadge = document.getElementById('paymentRail');
            
            if (investmentData.assetCurrency === 'NGN' || investmentData.assetCurrency === 'USD') {
                trustNoteText.textContent = 'Fiat wallets are securely managed by BuildVest via licensed payment partners.';
                paymentRailBadge.innerHTML = '<i class="fas fa-wallet mr-2"></i>Fiat Wallet';
            } else if (investmentData.assetCurrency === 'USDC') {
                trustNoteText.textContent = 'Stablecoin wallets are securely managed by BuildVest and powered by Circle.';
                paymentRailBadge.innerHTML = '<i class="fas fa-coins mr-2"></i>Stablecoin Wallet';
                paymentRailBadge.classList.remove('bg-blue-100', 'text-blue-800');
                paymentRailBadge.classList.add('bg-green-100', 'text-green-800');
            }
        }

        // Filter wallets by asset currency and display
        function filterAndDisplayWallets() {
            const eligibleWallets = getEligibleWalletsByAssetCurrency(investmentData.assetCurrency);
            const walletSelection = document.getElementById('walletSelection');
            
            if (eligibleWallets.length === 0) {
                walletSelection.innerHTML = `
                    <div class="bg-red-50 border-l-4 border-red-400 p-4 rounded">
                        <p class="text-sm text-red-800">
                            <i class="fas fa-exclamation-circle mr-2"></i>
                            No eligible wallets found for this asset currency. Please contact support.
                        </p>
                    </div>
                `;
                return;
            }

            walletSelection.innerHTML = eligibleWallets.map(wallet => {
                const hasSufficientBalance = wallet.availableBalance >= investmentData.investmentAmount;
                const walletTypeLabel = wallet.walletRail === 'FIAT' ? 'Fiat Custodial' : 'Stablecoin Custodial';
                const walletTypeBadgeClass = wallet.walletRail === 'FIAT' ? 'bg-blue-100 text-blue-800' : 'bg-green-100 text-green-800';
                
                return `
                    <div class="wallet-option border-2 rounded-lg p-4 cursor-pointer transition-all hover:border-blue-300 ${!hasSufficientBalance ? 'opacity-60 cursor-not-allowed' : ''}" 
                         data-wallet-id="${wallet.walletId}"
                         data-sufficient-balance="${hasSufficientBalance}">
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center space-x-3">
                                <i class="fas fa-wallet text-2xl ${wallet.walletRail === 'FIAT' ? 'text-blue-600' : 'text-green-600'}"></i>
                                <div>
                                    <h3 class="font-semibold text-gray-900">${wallet.label}</h3>
                                    <span class="text-sm text-gray-600">${wallet.currency}</span>
                                </div>
                            </div>
                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${walletTypeBadgeClass}">
                                ${walletTypeLabel}
                            </span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-600">Available Balance:</span>
                            <span class="font-semibold ${hasSufficientBalance ? 'text-green-600' : 'text-red-600'}">
                                ${formatCurrency(wallet.availableBalance, wallet.currency)}
                            </span>
                        </div>
                        ${!hasSufficientBalance ? '<div class="mt-2 text-xs text-red-600"><i class="fas fa-exclamation-circle mr-1"></i>Insufficient funds</div>' : ''}
                    </div>
                `;
            }).join('');

            // Add click handlers to wallet options
            document.querySelectorAll('.wallet-option').forEach(option => {
                option.addEventListener('click', handleWalletSelection);
            });
        }

        // Get eligible wallets by asset currency
        function getEligibleWalletsByAssetCurrency(assetCurrency) {
            return availableWallets.filter(wallet => 
                wallet.currency === assetCurrency && wallet.status === 'Active'
            );
        }

        // Handle wallet selection
        function handleWalletSelection(event) {
            const walletOption = event.currentTarget;
            const walletId = walletOption.dataset.walletId;
            const hasSufficientBalance = walletOption.dataset.sufficientBalance === 'true';

            if (!hasSufficientBalance) {
                showInsufficientFundsWarning();
                return;
            }

            // Remove previous selection
            document.querySelectorAll('.wallet-option').forEach(opt => {
                opt.classList.remove('border-blue-600', 'bg-blue-50');
            });

            // Add selection styling
            walletOption.classList.add('border-blue-600', 'bg-blue-50');
            
            selectedWalletId = walletId;
            hideInsufficientFundsWarning();
            validateAndEnableButton();
        }

        // Check if wallet has sufficient balance
        function hasSufficientBalance(walletId) {
            const wallet = availableWallets.find(w => w.walletId === walletId);
            return wallet && wallet.availableBalance >= investmentData.investmentAmount;
        }

        // Show insufficient funds warning
        function showInsufficientFundsWarning() {
            document.getElementById('insufficientFundsWarning').classList.remove('hidden');
        }

        // Hide insufficient funds warning
        function hideInsufficientFundsWarning() {
            document.getElementById('insufficientFundsWarning').classList.add('hidden');
        }

        // Validate and enable authorize button
        function validateAndEnableButton() {
            const authorizeButton = document.getElementById('authorizeButton');
            const isValid = selectedWalletId && hasSufficientBalance(selectedWalletId);
            authorizeButton.disabled = !isValid;
        }

        // Format currency
        function formatCurrency(amount, currency) {
            const formatMap = {
                'NGN': { symbol: '₦', decimals: 2 },
                'USD': { symbol: '$', decimals: 2 },
                'USDC': { symbol: '', decimals: 2, suffix: ' USDC' }
            };

            const format = formatMap[currency] || { symbol: '', decimals: 2 };
            const formattedAmount = amount.toLocaleString('en-US', {
                minimumFractionDigits: format.decimals,
                maximumFractionDigits: format.decimals
            });

            return `${format.symbol}${formattedAmount}${format.suffix || ''}`;
        }

        // Setup event listeners
        function setupEventListeners() {
            // Back button
            document.getElementById('backButton').addEventListener('click', () => {
                window.location.href = 'investment_amount_entry.html';
            });

            // Authorize button
            document.getElementById('authorizeButton').addEventListener('click', () => {
                if (selectedWalletId) {
                    onWalletSelected(selectedWalletId);
                }
            });

            // Fund wallet link
            document.getElementById('fundWalletLink').addEventListener('click', (e) => {
                e.preventDefault();
                window.open('wallet_management.html', '_blank');
            });
        }

        // Handle wallet selection confirmation
        function onWalletSelected(walletId) {
            // Persist selected wallet (in real app, use sessionStorage or API)
            sessionStorage.setItem('selectedWalletId', walletId);
            sessionStorage.setItem('investmentData', JSON.stringify(investmentData));
            
            // Proceed to review
            window.location.href = 'investment_review_confirmation.html';
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', initializePage);
    </script>
<script id="dhws-dataInjector" src="../public/dhws-data-injector.js"></script>
</body>
</html>